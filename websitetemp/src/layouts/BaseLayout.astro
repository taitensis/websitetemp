---
import type { ImageMetadata } from 'astro';
import { Button } from '@/components/ui/button';
import { buttonVariants } from '@/components/ui/button';

export interface Props {
  title?: string;
  description?: string;
  image?: string;
  noIndex?: boolean;

  bgUrl?: string | ImageMetadata;
  mainClass?: string;
}

import '../styles/global.css';
import ThemeToggle from '@/components/ThemeToggle';
import MobileMenu from '@/components/MobileMenu';
import LangMenu from '@/components/LangMenu';

import { useT, type Locale } from '@/i18n/home';
import { LOCALES, DEFAULT_LOCALE, getLocaleLabel } from '@/i18n/locales';
import { getRelativeLocaleUrl } from 'astro:i18n';

const current = (Astro.currentLocale ?? DEFAULT_LOCALE) as Locale;
const tt = useT(current);

const {
  title = 'Nourriture Quotidienne',
  description = 'A project to log my personal recipe collection.',
  image,
  noIndex = false,
  bgUrl,
  mainClass = '',
} = Astro.props;

const normalize = (v?: string | ImageMetadata) => (typeof v === 'string' ? v : v?.src);
const bg = normalize(bgUrl);

const overlayClassLight = 'bg-white/80'; // or 'bg-background/80'
const overlayClassDark = 'bg-black/70'; // or 'bg-background/80'

const site = typeof Astro.site === 'string' ? Astro.site : '';
const pageTitle = title === 'Nourriture Quotidienne' ? title : `${title} · Nourriture Quotidienne`;
const canonical = site ? new URL(Astro.url.pathname, site).toString() : undefined;

const urls = LOCALES.map((l) => getRelativeLocaleUrl(l));
const currentUrl = getRelativeLocaleUrl(current);

const langItems = LOCALES.map((l, i) => ({
  label: getLocaleLabel(l),
  url: urls[i],
  current: urls[i] === currentUrl,
}));

const currentLabel = getLocaleLabel(current);

const nav = [
  { label: tt('home'), url: getRelativeLocaleUrl(current, '/') },
  { label: tt('recipes'), url: getRelativeLocaleUrl(current, '/recipes') },
  { label: tt('about'), url: getRelativeLocaleUrl(current, '/about') },
];
---

<!doctype html>
<html
  lang={current}
  dir={current === 'ar' ? 'rtl' : 'ltr'}
  class="bg-background text-foreground h-full antialiased"
>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{pageTitle}</title>
    <meta name="description" content={description} />
    {noIndex && <meta name="robots" content="noindex,nofollow" />}
    {canonical && <link rel="canonical" href={canonical} />}

    {/* Open Graph / Twitter */}
    <meta property="og:type" content="website" />
    <meta property="og:title" content={pageTitle} />
    <meta property="og:description" content={description} />
    {image && <meta property="og:image" content={image} />}
    <meta name="twitter:card" content={image ? 'summary_large_image' : 'summary'} />
    <meta name="twitter:title" content={pageTitle} />
    <meta name="twitter:description" content={description} />
    {image && <meta name="twitter:image" content={image} />}

    {/* Prevent dark-mode flash */}
    <script>
      {
        `try {
        const saved = localStorage.getItem('theme');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        if (saved === 'dark' || (!saved && prefersDark)) {
          document.documentElement.classList.add('dark');
        }
      } catch (_) {}`;
      }
    </script>
  </head>

  <body class="flex min-h-dvh flex-col">
    <a
      href="#content"
      class="sr-only focus:not-sr-only focus:absolute focus:m-4 focus:rounded focus:bg-amber-200/80 focus:px-3 focus:py-2 focus:text-slate-800"
    >
      Skip to content
    </a>

    <header class="bg-background border-border border-b">
      <div class="mx-auto flex max-w-6xl items-center justify-between px-4 py-3">
        <!-- Brand -->
        <a href={import.meta.env.BASE_URL} class="flex items-center gap-2 font-semibold">
          <span class="text-xl tracking-tight">Nourriture Quotidienne</span>
        </a>

        <!-- Mobile: Theme toggle + hamburger -->
        <MobileMenu client:load langItems={langItems} currentLabel={currentLabel} nav={nav} />

        <!-- Desktop nav -->
        <nav class="hidden items-center gap-8 md:flex">
          <div id="left" class="inline-flex items-center gap-6">
            {
              nav.map((n) => (
                <a href={n.url} class={buttonVariants({ variant: 'ghost', size: 'default' })}>
                  {n.label}
                </a>
              ))
            }
          </div>
          <div id="right" class="flex items-center gap-2">
            <LangMenu client:load items={langItems} currentLabel={currentLabel} />
            <ThemeToggle client:load />
          </div>
        </nav>
      </div>
    </header>

    <main id="content" class={`relative isolate flex-1 py-10 ${mainClass}`}>
      {
        bg && (
          <div
            aria-hidden="true"
            class="absolute inset-0 z-0 bg-cover bg-center"
            style={`background-image:url('${bg}')`}
          />
        )
      }

      <!-- Always-on contrast overlays (light & dark) -->
      <div
        aria-hidden="true"
        class={`absolute inset-0 z-10 block dark:hidden pointer-events-none ${overlayClassLight}`}
      >
      </div>
      <div
        aria-hidden="true"
        class={`absolute inset-0 z-10 hidden dark:block pointer-events-none ${overlayClassDark}`}
      >
      </div>

      <div class="relative z-20">
        <slot />
      </div>
    </main>

    <footer class="border-border border-t">
      <div
        class="mx-auto flex max-w-6xl flex-col items-start justify-between gap-2 px-4 py-6 text-sm sm:flex-row sm:items-center"
      >
        <p>© {new Date().getFullYear()} Maxime C. — Recipes for everyday cooking.</p>
        <p>
          Built with <a
            href="https://astro.build"
            target="_blank"
            rel="noreferrer"
            class="hover:text-primary underline">Astro</a
          >,
          <a
            href="https://tailwindcss.com"
            target="_blank"
            rel="noreferrer"
            class="hover:text-primary ml-1 underline">Tailwind CSS</a
          >, and
          <a
            href="https://ui.shadcn.com"
            target="_blank"
            rel="noreferrer"
            class="hover:text-primary ml-1 underline">shadcn/ui</a
          >.
        </p>
      </div>
    </footer>
  </body>
</html>
